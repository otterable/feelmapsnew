<!DOCTYPE html>
<html>
<head>
    <title>Leaflet Map with Flask</title>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="http://cdn.leafletjs.com/leaflet/v1.7.1/leaflet.css" />

    <!-- Leaflet JavaScript -->
    <script src="http://cdn.leafletjs.com/leaflet/v1.7.1/leaflet.js"></script>

    <!-- Leaflet Draw CSS -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/1.0.4/leaflet.draw.css"/>

    <!-- Leaflet Draw JavaScript -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/1.0.4/leaflet.draw.js"></script>

    <!-- Heatmap plugin -->

    <!-- JQuery -->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
	
	
<style type="text/css">body { background-color: #1b1b1b; }
</style>

    <!-- The categories will be loaded from 'categories.html' -->
    <iframe id="categories-frame" style="display:none;" src="/categories"></iframe>
</head>
  <style>

/* BASIC CSS START */
body, html {
    margin: 0;
    padding: 0;
    overflow: hidden; /* Prevent scrolling */
    box-sizing: border-box; /* Include padding and border in the element's total width and height */
	font-family: 'Roboto', sans-serif !important;
}

*, *:before, *:after {
    box-sizing: inherit; /* Inherit box-sizing to make sure that padding and border are included in total width and height */
}

#map, #sidebar {
    position: absolute; /* Positioned absolutely to give precise control over their placement */
    top: 15px; /* Consistent margin from the top */
    bottom: 15px; /* Consistent margin from the bottom */
    border-radius: 30px;
}

#map {
    left: 15px; /* Consistent margin from the left */
    right: calc(30% + 15px); /* Adjusting for sidebar width and margin */
}

#sidebar {
    width: calc(30% - 15px); /* Sidebar takes up 30% width minus right margin */
    right: 15px; /* Consistent margin from the right */
    overflow-y: auto; /* Allows for scrolling within the sidebar if the content overflows */
    background: #111111;
    padding: 10px;
}


/* CUSTOM SCROLLBAR CSS START */
/* For Webkit (Chrome, Safari, Edge) */
::-webkit-scrollbar {
    display: none; /* Hide scrollbar for Webkit browsers */
}

/* Hide scrollbar for IE, Edge, and Firefox */
body {
    -ms-overflow-style: none;  /* IE and Edge */
    scrollbar-width: none;  /* Firefox */
}

/* Hide scrollbar for Chrome, Safari and Opera */
body::-webkit-scrollbar {
    display: none;
}

.leaflet-draw-edit-edit {
        display: none !important;
    }

/* CUSTOM SCROLLBAR CSS END */

/* CITY PICTURE CSS START */
.logo-img {
max-width: 100%;
width: 100%;
box-sizing: border-box;
height: auto;
display: block;
margin-left:auto;
margin-right:auto;
margin-top: 3px;
margin-bottom: 8px; 
border-radius: 30px;"
}
/* CITY PICTURE CSS END */



/* LEAFLET MAP PILL CSS START */
.leaflet-bar, .leaflet-draw-section, .leaflet-draw-section {
  border-radius: 30px !important;
  background-color: #3a3a3a !important;
}
/* LEAFLET MAP PILL CSS END */



/* LEAFLET MAP ICONS CSS START */
.leaflet-control-zoom-in, .leaflet-control-zoom-out, .leaflet-draw-draw-polyline, .leaflet-draw-draw-polygon, .leaflet-draw-draw-rectangle, .leaflet-draw-draw-circle, .leaflet-draw-draw-marker, .leaflet-draw-draw-circlemarker, .leaflet-draw-edit-edit, .leaflet-draw-edit-remove  {
  background-color: #3a3a3a !important;
  color: white !important;
  border: none !important;
  font-size: 18px !important;
  line-height: 30px !important;
  width: 30px !important;
  height: 30px !important;
}
/* LEAFLET MAP ICONS CSS END */



/* LEAFLET MAP ICON COLOR CHANGE WHEN DISABLED CSS START */
.leaflet-disabled {
  background-color: #111111 !important;
  color: white !important;
}
/* LEAFLET MAP ICON COLOR CHANGE WHEN DISABLED CSS END */



/* LEAFLET MAP ICON BORDER REMOVAL CSS START */
.leaflet-control-zoom-in, .leaflet-control-zoom-out {
  border-top: none !important;
  border-bottom: none !important;
  border-radius: 0 !important;
}
/* LEAFLET MAP ICON BORDER REMOVAL CSS END */



/* LEAFLET MAP ICON MISC CSS START */
.leaflet-bar > a:first-child {
  border-top-left-radius: 30px !important;
  border-top-right-radius: 30px !important;
}

.leaflet-bar > a:last-child {
  border-bottom-left-radius: 30px !important;
  border-bottom-right-radius: 30px !important;
}

.leaflet-control-layers-toggle {
    font-size: 30px;
    line-height: 24px;
    font-weight: bold;
    text-align: center;
    border-radius: 30px;
    background-color: transparent;
    background-repeat: no-repeat;
    background-position: center;
    width: 36px;
    height: 36px;
}

.leaflet-control-layers {
    border-radius: 30px;
    opacity: 1;
}

.leaflet-control-layers::before {
    content: "";
    background-image: url('static/mapicon2.png');
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    border-radius: 30px;
    background-size: cover;
    opacity: 1;
}

.leaflet-control-layers-expanded {
    background-color: #3a3a3a !important;
}

/* Hide the background image when the control layers menu is expanded */
.leaflet-control-layers-expanded::before {
    content: none !important;
}

.leaflet-control-layers-expanded .leaflet-control-layers-list {
    color: white;
    font-size: 15px;
    font-weight: bold;
    padding: 10px;  /* Added padding here */
}

.leaflet-control-layers-selector {
    border: 1px solid white !important;
    margin: 2px !important;
}

.leaflet-popup .leaflet-popup-content-wrapper .leaflet-popup-content {
    font-size: 20px !important;
}

/* Your existing rules for .leaflet-control-layers and .leaflet-top leaflet-right had typos, corrected below */
.leaflet-control-layers.leaflet-control {
    border-radius: 30px;
}

.leaflet-top.leaflet-right {
    border-radius: 50px;
}
/* LEAFLET MAP ICON MISC CSS END */



/* SMALL OPTIONS MENU TOP BUTTON CSS START */
/* This CSS makes sure the "smalloptionsmenutop" entity is resized properly */
 .smalloptionsmenutop {
      display: flex;
      justify-content: space-between;
    }
    .left-container, .right-container {
      display: flex;
      align-items: center;
    }
    .pinlist-div, .info-div, .lightswitch-div, .key-div {
      margin: 0 3px;
    }
}

  
    /* Individual icon divs */
    .lightswitch-div, .key-div, .pinlist-div, .info-div {
      flex-direction: row;
    }

    /* Make the containers hidden when screen width is less than 1271px */
    @media (max-width: 1271px) and (min-width: 780px) {
	  .left-container, .right-container, .togglebuttoncontainer {
		display: none;
	  }
	}
	
		/* Icon scaler */
        #keyDiv {
            cursor: pointer;
            margin: 0;
            padding: 0;
            display: flex;
            align-items: center; /* Vertically center the image */
        }

        #keyDiv img {
            max-width: 40px;  /* Adjust size as needed */
            height: auto;
            border-radius: 30px;
            margin: 0;
        }
		
        #infoDiv {
            cursor: pointer;
            margin: 0;
            padding: 0;
            display: flex;
            align-items: center; /* Vertically center the image */
        }

        #infoDiv img {
            max-width: 40px;  /* Adjust size as needed */
            height: auto;
            border-radius: 30px;
            margin: 0;
        }
		
        #pinlistdiv {
            cursor: pointer;
            margin: 0;
            padding: 0;
            display: flex;
            align-items: center; /* Vertically center the image */
        }

        #pinlistdiv img {
            max-width: 40px;  /* Adjust size as needed */
            height: auto;
            border-radius: 30px;
            margin: 0;
        }
		
        #lightswitchDiv {
            cursor: pointer;
            margin: 0;
            padding: 0;
            display: flex;
            align-items: center; /* Vertically center the image */
        }

        #lightswitchDiv img {
            max-width: 40px;  /* Adjust size as needed */
            height: auto;
            border-radius: 30px;
            margin: 0;
        }
/* SMALL OPTIONS MENU BUTTON CSS END */


/* BUTTON MAIN UNIVERSAL CSS START */
.button-u {
    font-weight: bold;
    display: flex;
    align-items: center;
    justify-content: center;
    margin: 14px 0;
    padding: 15px;
    box-sizing: border-box;
    cursor: pointer;
    text-decoration: none;
	    white-space: normal;
    border-radius: 30px;
    transition: background-color 0.2s ease-in-out;
    color: white;
    text-align: center;
    line-height: 1;
    max-height: 40px;
    width: 100%;
}
/* BUTTON MAIN UNIVERSAL CSS END */



/* BUTTON SMALL SIDEBAR CSS START */
/* This button is used mainly for Wie funktionierts. */
.button-s {
    font-weight: bold;
    display: flex;
    align-items: center;
    justify-content: center;
    margin: 14px 0;
    padding: 15px;
    box-sizing: border-box;
    cursor: pointer;
    text-decoration: none;
	    white-space: normal;
    border-radius: 30px;
    transition: background-color 0.2s ease-in-out;
    color: white;
    text-align: center;
    line-height: 1;
    max-height: 40px;
    width: 100%;
}
/* BUTTON SMALL SIDEBAR CSS END */



/* HOVER AND SELECTED BUTTON EFFECT CSS START */
/* Hover effect */
.button-s:hover, .categorybutton:hover, .post-button:hover, .key-div:hover, .pinlist-div:hover, .info-div:hover, .lightswitch-div:hover {
    filter: brightness(85%);
    outline: 3px solid var(--border-hover-color); /* Use custom property for outline color */
    outline-offset: -3px; /* Offset to align with the border edge */
}

/* Default state */
.button-s, .categorybutton, .post-button, .key-div, .pinlist-div, .info-div, .lightswitch-div {
    box-sizing: border-box;
    transition: all 0.2s ease-in-out;
    border: 3px solid transparent; /* Default border */
}


/* Selected effect */
.button-s.selected, .categorybutton.selected, .key-div.selected, .pinlist-div.selected, .info-div.selected, .lightswitch-div.selected {
    filter: brightness(85%);
    outline: 5px solid var(--border-selected-color); /* Use custom property for outline color */
    outline-offset: -5px; /* Offset to align with the border edge */
}

/* HOVER AND SELECTED BUTTON EFFECT CSS END */


/* INFO-POPUP CONTAINER CSS START */
/* Takes care of how big the info-popup is gonna be. This popup shows information about each element on the website. */
    #info-popup {
        padding: 20px;
        max-width: 500px;
        font-size: 14px;
        z-index: 1000;  /* Make sure the popup appears above the map */
    }
#info-popup.admin-pindelete-popup {
    max-width: 300px;
}
	
	#info-popup.uigif-counter-popup {
    max-width: 270px;
}

#info-popup.uigif-counter-popup img {
    border-radius: 30px;
}

#info-popup.admin-pinresize-popup {
 max-width: 300px;
}
/* INFO-POPUP CONTAINER CSS END */

        .count-pill {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            display: flex;
            align-items: center;
            padding: 10px 20px;
            border-radius: 30px;
            background-color: white; /* Change to desired background color */
            box-shadow: 0px 4px 6px rgba(0, 0, 0, 0.1); /* Optional */
            z-index: 10; /* Make sure it's above the map */
        }
        .color-circle {
            height: 15px;
            width: 15px;
            border-radius: 50%;
            display: inline-block;
            margin-right: 5px;
        }
        .category-symbol {
            margin-right: 5px;
        }
		
		
#counter-pill {
    position: absolute;
    top: 1.3%;
    left: 50%;
    transform: translate(-50%, -3%);
    display: flex;
    align-items: center;
    justify-content: center; /* Ensure items are centered horizontally */
    border-radius: 30px;
    padding: 4px; /* Even more increased padding for a larger pill */
    background-color: #111111;
    z-index: 10000; /* High z-index to bring to front */
    font-size: 2em; /* Larger font size */
    font-weight: bold; /* Make font bold */
    gap: 10px; /* Creates a gap between flex items */
}

.counter-item {
    display: flex;
    align-items: center;
}


.category-symbol {
    height: 25px; /* Set the size of the category symbol */
    width: 25px; /* Set the size of the category symbol */
    margin-right: 5px; /* Space after the symbol */
}

.counter-color {
    height: 25px; /* Set the height of the circle */
    width: 25px; /* Set the width of the circle */
    border-radius: 50%; /* Makes the div a circle */
    display: inline-block; /* Allows the div to behave like an image */
    margin-right: 15px; /* Space after the color circle */
}

.hidden {
    display: none !important; // !important to override any other display property
}

    </style>

<style>
@media (max-width: 767px) {
    body, html {
        padding-left: 7.5px; /* Add padding to the left of the body to create space for the content */
        padding-right: 7.5px; /* Add padding to the right of the body to create space for the content */
        margin: 0; /* Remove any margin that might interfere */
    }
	
	#counter-pill {
    position: absolute;
    top: 3%;
	}
	
    #map, #sidebar {
        position: relative; /* Stack the map and sidebar */
        top: 15px; /* Add top margin */
        left: 0; /* Align left edge with the viewport */
        right: 0; /* Align right edge with the viewport */
        border-radius: 30px; /* Add border radius */
        margin-bottom: 15px; /* Add bottom margin */
        width: auto; /* Auto width to fill the space with padding from body */
    }

    #map {
        height: 400px; /* Set fixed height for the map */
    }

    #sidebar {
        height: 400px; /* Set fixed height for the sidebar */
        overflow-y: auto; /* Enable scrolling if content overflows */
    }
	 .hide-on-mobile {
        display: none !important;
	}
	 .appear-on-mobile {
        display: block !important;
	}
#sidebar-mobileheader {
    position: relative;
    top: 15px;
    left: 0;
    right: 0;
    border-radius: 30px;
    margin-bottom: 15px;
    width: auto;
    display: block !important;
    padding: 7px; /* Add padding to create a gap inside */
}

    }

/* Media query for tablet devices */
@media (min-width: 768px) and (max-width: 1024px) {
    #map {
        left: 15px; /* Consistent margin from the left */
        right: calc(40% + 0px); /* Adjusting for sidebar width and right margin */
        top: 15px; /* Consistent margin from the top */
        bottom: 15px; /* Consistent margin from the bottom */
        border-radius: 30px; /* Maintain border radius */
    }
	
	

    #sidebar {
        width: calc(40% - 30px); /* Sidebar takes up 40% width minus the total horizontal margins */
        right: 15px; /* Consistent margin from the right */
        top: 15px; /* Consistent margin from the top */
        bottom: 15px; /* Consistent margin from the bottom */
        padding: 10px; /* Maintain padding */
        border-radius: 30px; /* Maintain border radius */
    }
	
}
</style>

<body>
<div class="color-111111" id="sidebar-mobileheader" style="display: none; background-color: #111111;">
<img class="logo-img appear-on-mobile" src="static/logo_long.png" style="display: none; max-width: 100%; height: auto; display: block; margin-bottom: 0px; border-radius: 0px;"/>
<h3 class="appear-on-mobiledisabled resistant-h3" style="display: none; color: white; text-align: center; margin-top: 5px;">Wie stehen Sie zu den Orten in Ihrer Gemeinde?</h3>
<h3 class="appear-on-mobiledisabled resistant-h3" style="display: none; color: white; text-align: center; margin-top: -12px; margin-bottom: 7px">Lassen Sie es uns auf dieser Karte wissen!</h3>
</div>

<div id="map"><!-- Inside the map div -->
<div id="counter-pill">
    <ul id="color-counters" style="list-style: none; display: flex; padding: 0; margin: 0;">
        <!-- Color circles will be inserted here -->
    </ul>
    <ul id="category-counters" style="list-style: none; display: flex; padding: 0; margin: 0;">
        <!-- Category symbols will be inserted here -->
    </ul>
</div>
</div>

<?php MAP END ?>
<?php SIDEBAR BODY START ?>
<div class="color-111111" id="sidebar" style="background-color: #111111;">
<?php LOGO START ?>
<img class="logo-img hide-on-mobile" src="static/logo_long.png" style="max-width: 100%; height: auto; display: block; margin-bottom: 7px; border-radius: 0px;"/>
<?php LOGO END ?>
<?php WEBSITE DESCRIPTION START ?>
<h3 class="hide-on-mobile resistant-h3" style="color: white; text-align: center; margin-top: 5px;">Wie stehen Sie zu den Orten in Ihrer Gemeinde?</h3>
<h3 class="hide-on-mobile resistant-h3" style="color: white; text-align: center; margin-top: -12px; margin-bottom: 7px">Lassen Sie es uns auf dieser Karte wissen!</h3>
<?php WEBSITE DESCRIPTION END ?>


<!-- SMALL OPTIONS MENU TOP START -->
<div class="smalloptionsmenutop" style="display: flex; align-items: center; justify-content: center;">
  <div class="left-container">
    <!-- This button shows the user a list of existing pins -->
    <div class="pinlist-div" id="pinlistdiv" onclick="togglePopup()" style="border-radius: 30px;">
      <img src="static/pinlisticon.png" />
    </div>
    <!-- This button shows the user a list of existing pins -->
    <div class="info-div" id="infoDiv" style="border-radius: 30px;">
      <img src="static/infoicon.png" />
    </div>
  </div>
  <div class="button-s color-3a3a3a" id="buttonS" onclick="addAndRemoveClass()" style="background-color: #3a3a3a; width: auto; height: auto; padding: 15px;">
    <h3>Wie funktioniert's?</h3>
  </div>
  <div class="right-container">
    <div class="lightswitch-div" id="lightswitchDiv" style="border-radius: 30px;">
      <img src="static/sunicon.png" />
    </div>
    <div class="key-div" id="keyDiv" style="border-radius: 30px;">
      <img src="static/keyicon.png" />
    </div>
  </div>
</div>
<!-- SMALL OPTIONS MENU TOP END -->


<?php CITY LOGO START ?>
<img class="hide-on-mobile resistant-image" id="overlay-image" src="static/overlay.jpg" style="max-width: 100%; height: auto; display: block; margin-left:auto; margin-right:auto; margin-top: 3px; margin-bottom: 5px; border-radius: 30px;"/>
<?php CITY LOGO END ?>

<?php ADMIN TOOLS (OTP PROTECTED) START // Categories here are dynamically generated from the "static/categories.html" file. Additional categories can be added or removed by editing "static/categories.html".?>
<div class="menu-admintools" id="dynamicgeneration-admintools"></div>
<?php ADMIN TOOLS (OTP PROTECTED) END // Categories here are dynamically generated from the "static/categories.html" file. Additional categories can be added or removed by editing "static/categories.html".?>

<?php CATEGORIES PULL START ?>
<iframe src="/categories" style="width:100%; height:100%; border:none;" frameborder="0"></iframe>
<?php CATEGORIES PULL END ?>
 

</div>
<?php SIDEBAR BODY END ?>

    <script>
	    var currentCategory = 'yellow'; // default category

        // Function to set category from iframe button click
        function setCategory(category) {
            currentCategory = category;
            console.log('Category set to:', currentCategory);
        }
	
        var map = L.map('map').setView([48.4102, 15.6022], 15);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            minZoom: 15,
            attribution: '© OpenStreetMap contributors | Stimmungskompass'
        }).addTo(map);
		
		// Map layers
var osmLayer = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    minZoom: 15,
    attribution: '....'
});

var satelliteLayer = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
    minZoom: 15,
    attribution: '&copy; Esri &mdash; Esri, i-cubed, USDA, USGS, AEX, GeoEye, Getmapping, Aerogrid, IGN, IGP, UPR-EGP, GIS User Community'
});

var thunderforestLayers = {
    "Atlas": L.tileLayer('https://tile.thunderforest.com/atlas/{z}/{x}/{y}.png?apikey=5c57f95ca93348f1a37f6572742a5b48', {
        minZoom: 15,
        attribution: 'Tiles © Thunderforest, ....'
    }),
    "Neighbourhood": L.tileLayer('https://tile.thunderforest.com/neighbourhood/{z}/{x}/{y}.png?apikey=5c57f95ca93348f1a37f6572742a5b48', {
        minZoom: 15,
        attribution: 'Tiles © Thunderforest, ....'
    }),
    "Transport": L.tileLayer('https://tile.thunderforest.com/transport/{z}/{x}/{y}.png?apikey=5c57f95ca93348f1a37f6572742a5b48', {
        minZoom: 15,
        attribution: 'Tiles © Thunderforest, ....'
    }),
    "Cycle": L.tileLayer('https://tile.thunderforest.com/cycle/{z}/{x}/{y}.png?apikey=5c57f95ca93348f1a37f6572742a5b48', {
        minZoom: 15,
        attribution: 'Tiles © Thunderforest, ....'
    }),
    "Mobile_Atlas": L.tileLayer('https://tile.thunderforest.com/mobile-atlas/{z}/{x}/{y}.png?apikey=5c57f95ca93348f1a37f6572742a5b48', {
        minZoom: 15,
        attribution: 'Tiles © Thunderforest, ....'
    }),
    "Pioneer": L.tileLayer('https://tile.thunderforest.com/pioneer/{z}/{x}/{y}.png?apikey=5c57f95ca93348f1a37f6572742a5b48', {
        minZoom: 15,
        attribution: 'Tiles © Thunderforest, ....'
    }),
};

var baseLayers = {
    "Standardkarte": osmLayer,
    "Satellit": satelliteLayer,
    "Klar 1": thunderforestLayers.Atlas,
    "Klar 2": thunderforestLayers.Neighbourhood,
    "Öffi": thunderforestLayers.Transport,
    "Radwege": thunderforestLayers.Cycle,
    "Atlas": thunderforestLayers.Mobile_Atlas,
    "Papyrus": thunderforestLayers.Pioneer,
};


        // Add default layer to map
        baseLayers["Standardkarte"].addTo(map);

        // Layers control
        L.control.layers(baseLayers).addTo(map);

        var drawnItems = new L.FeatureGroup();
        map.addLayer(drawnItems);

        var drawControl = new L.Control.Draw({
            edit: {
                featureGroup: drawnItems
            }
        });
        map.addControl(drawControl);


	
		
    map.on(L.Draw.Event.CREATED, function(event) {
        var layer = event.layer;
        var type = event.layerType;
        var color = currentCategory; // Use the currentCategory as the color for the shape
        var shapeType = layer instanceof L.Marker ? 'marker' : type.toLowerCase();

    layer.options.shapeType = type.toLowerCase(); // Make sure this is consistent with your types

    
    // Apply the selected category's color to the shape
    if (type === 'marker') {
        // For markers, set the icon color based on category
        // You will need to have custom icons for this or use a plugin
    } else {
        // For other types like polygons, set the color directly
        layer.setStyle({ color: currentCategory });
    }

    drawnItems.addLayer(layer);
    var shapeData = layer.toGeoJSON();
    var shapeType = layer instanceof L.Marker ? 'marker' : type.toLowerCase();
    var radius = type === 'circle' || type === 'circlemarker' ? layer.getRadius() : null;

	// Populate the shapeLayersByColor and shapeLayersByType objects
        if (!shapeLayersByColor[color]) {
            shapeLayersByColor[color] = [];
        }
        if (!shapeLayersByType[shapeType]) {
            shapeLayersByType[shapeType] = [];
        }
        shapeLayersByColor[color].push(layer);
        shapeLayersByType[shapeType].push(layer);
        console.log('Added layer to shapeLayersByColor and shapeLayersByType', layer);


	
    // Bind popup to the layer
    var popupContent = '<form id="note-form">' +
                       '<textarea id="shape-note" placeholder="Enter your note here"></textarea><br>' +
                       '<button type="button" id="save-note">Post</button>' +
                       '<button type="button" id="cancel-note">Cancel</button>' +
                       '</form>';

    layer.bindPopup(popupContent, {
        keepInView: true,
        closeButton: false
    }).openPopup();

    layer.on('popupopen', function() {
        // Add event listeners inside the popupopen event to ensure elements are available
        var saveButton = document.getElementById('save-note');
        var cancelButton = document.getElementById('cancel-note');

        // Save note button event listener
        saveButton.addEventListener('click', function() {
            var noteText = document.getElementById('shape-note').value;
            console.log('Post button clicked. Saving note:', noteText);
            saveShapeWithData(shapeData, shapeType, radius, noteText, layer);
            layer.closePopup();
        });

        // Cancel note button event listener
        cancelButton.addEventListener('click', function() {
            console.log('Cancel button clicked. Canceling shape creation.');
            layer.closePopup();
            drawnItems.removeLayer(layer);
        });
    });
});

// Function to save shape with a note
function bindPopupWithNote(layer, note) {
    var popupContent = '<div><strong>Note:</strong> ' + note + '</div>';
    layer.bindPopup(popupContent, {
        keepInView: true
    });
}

// Function to save shape with a note and then bind the popup
function saveShapeWithData(shapeData, shapeType, radius, note, layer) {
    $.ajax({
        url: '/api/shapes',
        method: 'POST',
        contentType: 'application/json',
        data: JSON.stringify({
            shape_data: shapeData,
            shape_type: shapeType,
            shape_color: currentCategory,
            radius: radius,
            shape_note: note
        }),
        success: function(response) {
            console.log('Shape saved with ID:', response.id);
            layer.options.id = response.id; // Assign the ID from the response to the layer immediately
            bindPopupWithNote(layer, note); // Bind the popup with the note
            drawnItems.addLayer(layer);
            console.log('Shape and note saved to the database.');
        },
        error: function(xhr, status, error) {
            console.error('Error saving shape:', error);
        }
    });
}
// Load shapes from server


// This function will handle the deletion of shapes
// Function to handle individual shape deletion
function handleDelete(layer) {
    var shapeId;
    // Check for the id in various possible locations within the layer object
    if (layer.options && layer.options.id) {
        shapeId = layer.options.id;
    } else if (layer.feature && layer.feature.properties && layer.feature.properties.id) {
        shapeId = layer.feature.properties.id;
    } else if (layer._layers) {
        // If the layer is a FeatureGroup, check each sub-layer for an id
        var subLayers = Object.values(layer._layers);
        if (subLayers.length > 0 && subLayers[0].feature && subLayers[0].feature.properties) {
            shapeId = subLayers[0].feature.properties.id;
        }
    }
    
    if (shapeId) {
        console.log('Deleting shape with ID:', shapeId);
        $.ajax({
            url: '/api/shapes/' + shapeId,
            type: 'DELETE',
            success: function(response) {
                console.log('Shape deleted with ID:', shapeId);
            },
            error: function(xhr, status, error) {
                console.error('Error deleting shape with ID:', shapeId, error);
            }
        });
        map.removeLayer(layer);
    } else {
        console.error('Error: shape ID is undefined, cannot delete. Layer:', layer);
        // Additional logging to debug the layer's structure
        console.log('Layer details:', layer);
        if (layer._layers) {
            console.log('Nested layers:', Object.values(layer._layers));
        }
    }
}
  // Function to load shapes from the server
    function loadShapes() {
    console.log('Stimmungskompass v8.11.2023_rc1 | Ermine | Loading shapes...');
    $.get('/api/shapes', function(response) {
        console.log('Loading successful, total shapes received:', response.shapes.length);
        response.shapes.forEach(function(shape) {
            var shapeLayer;
            var center, radius, popupContent;
            var shapeType = shape.shape_type.toLowerCase(); // Make sure 'shapeType' is defined correctly based on your API response


                if (shapeType === 'circle' || shapeType === 'circlemarker') {
                    center = L.GeoJSON.coordsToLatLng(shape.shape_data.geometry.coordinates);
                    radius = shape.radius;
                    shapeLayer = L.circle(center, { color: shape.shape_color, radius: radius });
                } else {
                    shapeLayer = L.geoJSON(shape.shape_data, {
                        style: function() { return { color: shape.shape_color }; }
                    });
                }

                // Attach the ID to the layer
                shapeLayer.options.id = shape.id;
				shapeLayer.options.shapeType = shapeType; // Make sure 'shapeType' is defined correctly based on your API response


                // Initialize arrays if they don't exist
                if (!shapeLayersByColor[shape.shape_color]) {
                    shapeLayersByColor[shape.shape_color] = [];
                }
                if (!shapeLayersByType[shapeType]) {
                    shapeLayersByType[shapeType] = [];
                }

                // Add the layer to the respective arrays
                shapeLayersByColor[shape.shape_color].push(shapeLayer);
                shapeLayersByType[shapeType].push(shapeLayer);

                // Bind popup and click event if a note is present
                if (shape.shape_note) {
                    popupContent = '<div><strong>Note:</strong> ' + shape.shape_note + '</div>';
                    shapeLayer.bindPopup(popupContent, {
                        keepInView: true
                    });
                }

                // Add the layer to the map
                drawnItems.addLayer(shapeLayer);
                console.log('Shape loaded and added to map:', shapeLayer);
            });
            console.log('Shapes loaded.');
        }).fail(function(jqXHR, textStatus, errorThrown) {
            console.error('Failed to load shapes:', textStatus, errorThrown);
        });
    }





map.on(L.Draw.Event.DELETED, function(event) {
    var layers = event.layers;
    layers.eachLayer(function(layer) {
        console.log('Preparing to delete layer:', layer);
        handleDelete(layer);
    });
});

map.on('draw:deletestop', function(event) {
    if (event.target._deletedLayers) {
        event.target._deletedLayers.eachLayer(function(layer) {
            console.log('Clearing layer:', layer);
            handleDelete(layer);
        });
    }
});

loadShapes();


</script>
	
	
	

<?php DARK AND LIGHT MODE SWITCH START ?>
<script>
// Dark and light mode switcher
console.log("Dark and light mode switcher succesfully loaded.");
let isLightMode = false;  // Initialize with dark mode

// Ensure the dark mode is set on initial load
document.documentElement.classList.add('dark-mode');

// Function to switch between light and dark mode
function toggleLightMode() {
  // Toggle the mode first before applying the classes
  isLightMode = !isLightMode;
  document.documentElement.classList.toggle('dark-mode', !isLightMode);
  document.documentElement.classList.toggle('light-mode', isLightMode);

  // Helper function to safely set the src attribute for all elements matching the selector
  function setImgSrc(selector, lightSrc, darkSrc) {
    const elements = document.querySelectorAll(selector);
    elements.forEach(element => {
      element.src = isLightMode ? lightSrc : darkSrc;
    });
  }

  // Update the image sources based on the mode
  setImgSrc('.logo-img', 'static/logo_long2.png', 'static/logo_long.png');
  setImgSrc('#pinlistdiv img', 'static/pinlisticon2.png', 'static/pinlisticon.png');
  setImgSrc('#infoDiv img', 'static/infoicon2.png', 'static/infoicon.png');
  setImgSrc('#lightswitchDiv img', 'static/sunicon2.png', 'static/sunicon.png');
  setImgSrc('#keyDiv img', 'static/keyicon2.png', 'static/keyicon.png');

  // Update the body's background color
  document.body.style.backgroundColor = isLightMode ? '#F4F4ED' : '#1b1b1b';

  // Update the sidebar background color
  const sidebar = document.getElementById('sidebar');
  const sidebarMobileHeader = document.getElementById('sidebar-mobileheader');
  if (sidebar) {
    sidebar.style.backgroundColor = isLightMode ? '#D4D7DA' : '#111111';
  }
  if (sidebarMobileHeader) {
    sidebarMobileHeader.style.backgroundColor = isLightMode ? '#D4D7DA' : '#111111';
  }

  // Update the button's background color
  const buttonS = document.getElementById('buttonS');
  if (buttonS) {
    buttonS.style.backgroundColor = isLightMode ? '#111111' : '#3a3a3a';
  }

  // Update the text color for h3 elements with 'resistant-h3' class
  const h3Elements = document.querySelectorAll('.resistant-h3');
  h3Elements.forEach(el => {
    el.style.color = isLightMode ? 'black' : 'white';
  });

  // Update the text color for text elements with 'text-color' class
  const textElements = document.querySelectorAll('.text-color');
  textElements.forEach(el => {
    el.style.color = isLightMode ? 'black' : 'white';
  });

  console.log("Light mode is now " + (isLightMode ? "enabled" : "disabled") + ".");
}

// Add event listener to the light switch div
document.getElementById('lightswitchDiv').addEventListener('click', toggleLightMode);

</script>
<style>

/* Dark mode styles (default) */
.dark-mode {
    --bg-color1: #1b1b1b;
    --bg-color2: #111111;
    --bg-color3: #3a3a3a;
    --text-color: #ffffff;
    --logo-img: "static/logo_long.png";
    --key-icon: "static/keyicon.png";
    --sun-icon: "static/sunicon.png";
    --info-icon: "static/infoicon.png";
    --pinlist-icon: "static/pinlisticon.png";
	--border-hover-color: white; /* Set hover border color for dark mode */
    --border-selected-color: white; /* Set selected border color for dark mode */
}

/* Light mode styles */
.light-mode {
    --bg-color1: #F4F4ED;
    --bg-color2: #D4D7DA;
    --bg-color3: #000000;
    --text-color: #000000;
    --logo-img: "static/logo_long2.png";
    --key-icon: "static/keyicon2.png";
    --sun-icon: "static/sunicon2.png";
    --info-icon: "static/infoicon2.png";
    --pinlist-icon: "static/pinlisticon2.png";
	--border-hover-color: black !important; /* Set hover border color for light mode */
    --border-selected-color: black !important; /* Set selected border color for light mode */
}
</style>
<script>
// On website launch, the layout is DARK.
let isDarkMode = true;

function togglePopup() {
    isDarkMode = !isDarkMode;
    document.documentElement.classList.toggle('dark-mode', isDarkMode);
    document.documentElement.classList.toggle('light-mode', !isDarkMode);
}
</script>
<?php DARK AND LIGHT MODE SWITCH END ?>

<?php BUTTON CLICK AUDIO EFFECTS START ?>
<audio id="buttonClickAudio" preload="auto">
    <source src="static/buttonclick.mp3" type="audio/mp3"/>
</audio>
<script>
document.addEventListener('DOMContentLoaded', function() {
    function playClickSound() {
        // Create a new audio element for each click
        var audio = new Audio('static/buttonclick.mp3');
        // Attempt to play audio without waiting for the promise to resolve
        audio.play().catch(function(e) {
            console.error('Audio play failed:', e);
        });
    }

    // Attach event listener to the static parent element for delegation
    document.addEventListener('click', function(event) {
        // Ensure the clicked element matches the dynamic buttons
        if (event.target.closest('#dynamicgeneration-categorypicker .categorybutton')) {
            playClickSound();
        }
    });
});
</script>
<script>
// General click sound effect
document.addEventListener('DOMContentLoaded', function() {
    // Get the audio element
    const audio = document.getElementById('buttonClickAudio');
    
    // Add click event listener to all elements with class 'button-s'
    const buttonSs = document.querySelectorAll('.button-s');
    buttonSs.forEach((button) => {
        button.addEventListener('click', function() {
            audio.play();
        });
    });

    // Add click event listener to all elements with class 'categorybutton'
    const categorybuttons = document.querySelectorAll('.categorybutton');
    categorybuttons.forEach((button) => {
        button.addEventListener('click', function() {
            audio.play();
        });
    });
	
	    // Add click event listener to all elements with class 'button-s'
    const keyDivs = document.querySelectorAll('.key-div');
    keyDivs.forEach((button) => {
        button.addEventListener('click', function() {
            audio.play();
        });
    });
	
	    // Add click event listener to all elements with class 'button-s'
    const pinlistdivs = document.querySelectorAll('.pinlist-div');
    pinlistdivs.forEach((button) => {
        button.addEventListener('click', function() {
            audio.play();
        });
    });
	
		    // Add click event listener to all elements with class 'button-s'
    const lightswitchDivs = document.querySelectorAll('.lightswitch-div');
    lightswitchDivs.forEach((button) => {
        button.addEventListener('click', function() {
            audio.play();
        });
    });
	
		    // Add click event listener to all elements with class 'button-s'
    const infoDivs = document.querySelectorAll('.info-div');
    infoDivs.forEach((button) => {
        button.addEventListener('click', function() {
            audio.play();
        });
    });
	
});
</script>
<audio id="buttonClickAudio2"><source src="static/buttonclickSuccess.mp3" type="audio/mp3"/></audio>
<audio id="buttonClickAudio3"><source src="static/buttonclickClose.mp3" type="audio/mp3"/></audio>
<script>
// Popup closing sound effect
document.addEventListener('DOMContentLoaded', function() {
    // Get the audio elements
    const audioSuccess = document.getElementById('buttonClickAudio2');
    const audioClose = document.getElementById('buttonClickAudio3');
    
    // Add event listener to the body element for delegation
    document.body.addEventListener('click', function(event) {
            if (event.target.matches('.leaflet-popup-content button:nth-child(1)')) {
            audioSuccess.play();
        }     else if (event.target.matches('.leaflet-popup-content button:nth-child(2)')) {
            audioClose.play();
        }
    });
});
</script>
<?php BUTTON CLICK AUDIO EFFECTS END ?>

<?php BOTTOM RIGHT CORNER INFOPOPUP LOGIC START ?>
<script>
document.addEventListener("DOMContentLoaded", () => {
    const popupTexts = {  
        'Login': {
			title: '<span style="color: #35b7ff;">Admin-Zugriff</span>',
            text: `<form id="loginForm" onsubmit="handleLogin(); return false;">
                <label for="username">Benutzer:</label>
                <input type="text" id="username" name="username"><br><br>

                <label for="password">Passwort:</label>
                <input type="password" id="password" name="password"><br><br>

                <label for="otp">OTP 2FA Token:</label>
                <input type="text" id="otp" name="otp"><br><br>

                <button type="submit" class="button-s" style="padding: 20px; background-color: #35b7ff; border: none; cursor: pointer;">
                    <span style="position: relative; top: 0px;">Anmelden</span>
                </button>
            </form>`,
            color: 'white',
            persist: true
        },
        'uigif-counter': {
            title: 'So funktioniert Filtern:',
            text: '<img src="static/uigif-counter.gif" alt="uigif-counter" style="max-width: 100%; max-height: 800px; width: auto; height: auto;">',
            color: '#ffffff',
            persist: true  // Keep this popup visible forever
        },
		'admin-pindelete': {
        title: 'Einzelne Pins löschen:',
        text: '<img src="static/uigif-deletebyid.gif" alt="uigif-deletebyid" style="max-width: 100%; max-height: 800px; width: auto; height: auto;">',
        color: '#ffffff',
        persist: true  // Keep this popup visible forever
		},
		'admin-pinresize': {
        title: 'Größenänderung:',
        text: '<img src="static/uigif-resize.gif" alt="uigif-resize" style="max-width: 100%; max-height: 800px; width: auto; height: auto;">',
        color: '#ffffff',
        persist: true  // Keep this popup visible forever
		},
        'Overlay': {
            title: '<span style="color: #35b7ff;">Dieses Bild wird ersetzt:</span>',
            text: '<img src="static/overlay.jpg" alt="Overlay Image" style="max-width: 100%; max-height: 400px; width: auto; height: auto; border-radius: 30px;">',
            color: '#ffffff',
            persist: true  // Keep this popup visible forever
        },
        'Success': {
            title: 'Anmeldung erfolgreich!',
            text: 'Wenn Sie Hilfe benötigen, sehen Sie sich die Anleitung an oder wenden Sie sich an den Entwickler.',
            color: 'green',
            persist: false
        },
        'Willkommen auf der Stimmungskarte!': {
            title: 'Willkommen auf der Stimmungskarte!',
            text: 'Diese Karte ist eine bequeme und einfache Möglichkeit, Ihrer Stadt zu zeigen, wie Sie sich darin fühlen.<br><br>Sie können Hinweise an Orten anbringen, die Sie entweder als angenehm oder problematisch empfinden.<br><br><span style="color: #f77f00; font-weight: bold;">Und so funktioniert es:</span><br><span style="color: #f77f00; font-weight: bold;">1.</span> Wählen Sie eine Kategorie.<br><span style="color: #f77f00; font-weight: bold;">2.</span> Platzieren Sie einen Pin auf der Karte.<br><span style="color: #f77f00; font-weight: bold;">3.</span> Teilen Sie uns Ihre Meinung mit!<br><br><span style="font-weight: bold;">Ihre Beiträge sind anonym und können von der Gemeinde zur Verbesserung des öffentlichen Raums genutzt werden.</span> ',
            color: '#f77f00'
        },
		<!-- CATEGORY EDITING AREA START -->
        'Dieser Ort gefällt mir.': {
            title: 'Was kann man zum Beispiel aufschreiben?',
            text: 'Dieser Ort strahlt eine beruhigende Ruhe aus und bietet eine angenehme Atmosphäre, die zum Entspannen einlädt.  Ob durch seine natürliche Schönheit oder aufregende Aktivitäten, er vermag es, einen positiven Eindruck zu hinterlassen.',
            color: '#FF7043'
        },
        'Hier fühle ich mich unsicher.': {
            title: 'Was kann man zum Beispiel aufschreiben?',
            text: 'Die schlechte Straßenbeleuchtung lässt ein Gefühl der Unsicherheit aufkommen, während betrunkene oder obdachlose Personen die Unbehaglichkeit weiter verstärken.   Hier wäre eine Aufwertung der öffentlichen Infrastruktur und mehr soziale Dienste wünschenswert.',
            color: '#B71C1C'
        },
        'Hier gibt es Probleme mit dem Parken.': {
            title: 'Was kann man zum Beispiel aufschreiben?',
            text: 'Die knappen Parkmöglichkeiten und rücksichtslos abgestellte Fahrzeuge erschweren die Durchfahrt und schaffen ein chaotisches Straßenbild.   Eine bessere Regulierung und Beschilderung könnte hier Abhilfe schaffen.',
            color: '#1565C0'
        },
        'Hier verbringe ich gerne meine Freizeit.': {
            title: 'Was kann man zum Beispiel aufschreiben?',
            text: 'Dieser Ort bietet eine friedliche Oase zum Abschalten oder ein lebendiges Markttreiben, das zum Stöbern einlädt.   Die angenehme Umgebung, sei es ein Bauernmarkt oder ein Kino, macht ihn zu einem beliebten Freizeitziel.',
            color: '#4CAF50'
        },
        'Dieser Ort braucht eine Verbesserung.': {
            title: 'Was kann man zum Beispiel aufschreiben?',
            text: 'Die fehlende Fußgängerüberquerung und der heruntergekommene Anblick, gepaart mit Schlaglöchern im Straßenbelag, rufen nach Verbesserungen.   Eine Aufwertung der Ästhetik und Sicherheit würde den Ort deutlich attraktiver machen.',
            color: '#4E342E'
        },
        'An diesem Ort fehlt ein Service.': {
            title: 'Was kann man zum Beispiel aufschreiben?',
            text: 'Die mangelhafte Busanbindung und geschlossene Apotheken erschweren den Alltag und lassen den Ort weniger serviceorientiert erscheinen.   Eine Verbesserung der öffentlichen Dienstleistungen wäre hier von Vorteil.',
            color: 'white'
        },
		<!-- CATEGORY EDITING AREA END -->

    };

    // Function to create and show the popup
    let popupTimer;
    let buttonTimer;

    function showPopup(info) {
        clearTimeout(popupTimer);
        const existingPopup = document.getElementById("info-popup");
        if (existingPopup) {
            existingPopup.remove();
        }
		
		

        const popup = document.createElement("div");
        popup.id = "info-popup";
        popup.style.backgroundColor = isLightMode ? "rgba(212,215,218, 1)" : "rgba(17, 17, 17, 1)";
        popup.style.color = isLightMode ? "black" : "white";
        popup.style.borderRadius = "30px";
        popup.style.position = "absolute";
        popup.style.bottom = "10px";
        popup.style.right = "10px";
        popup.style.marginLeft = "10px";
        popup.style.marginTop = "10px";
        popup.style.zIndex = "1000";
        popup.style.opacity = "0";
        popup.style.transition = "opacity 0.2s ease-in";

        const title = document.createElement("h3");
        title.style.color = info.color;
        title.style.fontWeight = "bold";
        title.style.fontSize = "24px";
        title.innerHTML = info.title;
        popup.appendChild(title);

        const text = document.createElement("p");
        text.style.fontWeight = "bold";
        text.style.fontSize = "18px";
        text.innerHTML = info.text;
        popup.appendChild(text);

        document.getElementById("map").appendChild(popup);

        popup.addEventListener('click', function (event) {
            event.stopPropagation();
        });

        setTimeout(() => {
            popup.style.opacity = "1";
        }, 0);

        let timeout = 5000;  // Default timeout in milliseconds
        if (info.title === 'Willkommen auf der Stimmungskarte!') {
            timeout = 15000;  // 15 seconds for 'Willkommen' popup
        } else if (info.title === 'Dieses Bild wird ersetzt:') {
            timeout = -1;  // Infinite for 'Overlay' popup
        }
		
		// Check if this is the 'uigif-counter' popup and add a specific class
		if (info.title === 'So funktioniert Filtern:') {
        popup.classList.add('uigif-counter-popup');
		} else if (info.title === 'Größenänderung:') {
        popup.classList.add('admin-pinresize-popup');
} else if (info.title === 'Einzelne Pins löschen:') {
    popup.classList.add('admin-pindelete-popup');

		}
		
        if (!info.persist) {
            clearTimeout(popupTimer);
            popupTimer = setTimeout(() => {
                popup.style.opacity = "0";
                setTimeout(() => {
                    popup.remove();
                }, 500);
            }, timeout);
        }
    }

    function activatePopup() {
        const info = popupTexts['Willkommen auf der Stimmungskarte!'];
        showPopup(info);
    }

    function activatePopupByKey() {
        const info = popupTexts['Login'];
        showPopup(info);

        const loginForm = document.getElementById("loginForm");
        if (loginForm) {
            loginForm.addEventListener("submit", function (event) {
                event.preventDefault();
                const formData = new FormData(loginForm);
                const username = formData.get("username");
                const password = formData.get("password");
                const otp = formData.get("otp");

                fetch("/login", {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/x-www-form-urlencoded",
                    },
                    body: `username=${username}&password=${password}&otp=${otp}`,
                })
                    .then(response => response.json())
                    .then(data => {
                        if (data.status === "success") {
                            const successInfo = popupTexts['Success'];
                            showPopup(successInfo);

                            const imageToHide = document.querySelector(".hide-on-mobile.resistant-image");
                            if (imageToHide) {
                                imageToHide.style.display = 'none';
                            }

                            const h3ElementsToHide = document.querySelectorAll(".resistant-h3");
                            if (h3ElementsToHide) {
                                h3ElementsToHide.forEach((element) => {
                                    element.style.display = 'none';
                                });
                            }

                            const adminTools = document.querySelector(".admintools-container");
                            if (adminTools) {
                                adminTools.style.display = 'block';
                            }
                        } else {
                            alert("Failed: " + data.message);
                        }
                    })
                    .catch(error => {
                        alert("An error occurred: " + error);
                    });
            });
        }
    }
	
// Add new code here
const counterContainer = document.getElementById('counter-container');
let isUIGifCounterPopupVisible = false;
// New code for admin-pindelete
const adminPinDelete = document.getElementById('adminpindelete');
let isAdminPinDeletePopupVisible = false;

if (adminPinDelete) {
    adminPinDelete.addEventListener('mouseover', () => {
        if (!isAdminPinDeletePopupVisible) {
            const adminPinDeleteInfo = popupTexts['admin-pindelete'];
            showPopup(adminPinDeleteInfo);
            isAdminPinDeletePopupVisible = true;
        }
    });

    adminPinDelete.addEventListener('mouseout', () => {
        if (isAdminPinDeletePopupVisible) {
            const existingPopup = document.getElementById("info-popup");
            if (existingPopup) {
                existingPopup.style.opacity = "0";
                setTimeout(() => {
                    existingPopup.remove();
                }, 500);
            }
            isAdminPinDeletePopupVisible = false;
        }
    });
}


if (counterContainer) {
    counterContainer.addEventListener('mouseover', (event) => {
        if (!isUIGifCounterPopupVisible) {
            const uigifCounterInfo = popupTexts['uigif-counter'];
            showPopup(uigifCounterInfo);
            isUIGifCounterPopupVisible = true;
        }
    });

    counterContainer.addEventListener('mouseout', (event) => {
        // Check if the mouse is actually leaving the counterContainer or simply moving to a child element
        const isMouseLeavingContainer = !counterContainer.contains(event.relatedTarget);
        
        if (isUIGifCounterPopupVisible && isMouseLeavingContainer) {
            const existingPopup = document.getElementById("info-popup");
            if (existingPopup) {
                existingPopup.style.opacity = "0";
                setTimeout(() => {
                    existingPopup.remove();
                }, 500);
            }
            isUIGifCounterPopupVisible = false;
        }
    });
}

// New code for admin-pinresize
const adminPinResize = document.getElementById('adminpinresize');
let isAdminPinResizePopupVisible = false;

if (adminPinResize) {
    adminPinResize.addEventListener('mouseover', () => {
        if (!isAdminPinResizePopupVisible) {
            const adminPinResizeInfo = popupTexts['admin-pinresize'];
            showPopup(adminPinResizeInfo);
            isAdminPinResizePopupVisible = true;
        }
    });

    adminPinResize.addEventListener('mouseout', () => {
        if (isAdminPinResizePopupVisible) {
            const existingPopup = document.getElementById("info-popup");
            if (existingPopup) {
                existingPopup.style.opacity = "0";
                setTimeout(() => {
                    existingPopup.remove();
                }, 500);
            }
            isAdminPinResizePopupVisible = false;
        }
    });
}

    let isOverlayPopupVisible = false;

    window.toggletitelbildMenu = function () {
        var titelbildMenu = document.getElementById('titelbild-menu');
        if (titelbildMenu.style.display === 'none') {
            titelbildMenu.style.display = 'block';
            const overlayInfo = popupTexts['Overlay'];
            showPopup(overlayInfo);
            isOverlayPopupVisible = true;
        } else {
            titelbildMenu.style.display = 'none';
            if (isOverlayPopupVisible) {
                const existingPopup = document.getElementById("info-popup");
                if (existingPopup) {
                    existingPopup.style.opacity = "0";
                    setTimeout(() => {
                        existingPopup.remove();
                    }, 500);
                }
                isOverlayPopupVisible = false;
            }
        }
    };
	

	
	// New code for infoDiv
    const infoDiv = document.getElementById('infoDiv');
    if (infoDiv) {
        infoDiv.addEventListener('click', () => {
            window.open('https://stimmungskompass.at', '_blank');
        });
    }


    const keyDiv = document.querySelector("#keyDiv");
    if (keyDiv) {
        keyDiv.addEventListener("click", activatePopupByKey);
    }

    const buttonS = document.querySelector(".button-s");
    if (buttonS) {
        buttonS.addEventListener("click", activatePopup);
    }

    const categorybuttons = document.querySelectorAll(".categorybutton");
    categorybuttons.forEach(menu => {
        menu.addEventListener("click", (event) => {
            const title = event.currentTarget.querySelector("h3").textContent;
            const info = popupTexts[title];
            showPopup(info);
        });
    });
});
</script>
<?php BOTTOM RIGHT CORNER INFOPOPUP LOGIC END ?>

<script>
function handleLogin() {
  // Assuming you have form inputs with IDs 'username', 'password', and 'otp'
  var username = document.getElementById('username').value;
  var password = document.getElementById('password').value;
  var otp_token = document.getElementById('otp').value;

  // Create an AJAX request to the server for logging in
  var xhr = new XMLHttpRequest();
  xhr.open('POST', '/login', true);
  xhr.setRequestHeader('Content-Type', 'application/x-www-form-urlencoded');
  xhr.onload = function() {
    if (this.status === 200) {
      // If login is successful, load the admin tools
      loadAdminTools();
    } else {
      // Handle login failure, maybe show an error message
      console.error('Login failed:', this.responseText);
    }
  };
  xhr.onerror = function() {
    // When an error occurs during the request
    console.error("Request failed.");
  };
  xhr.send(`username=${encodeURIComponent(username)}&password=${encodeURIComponent(password)}&otp=${encodeURIComponent(otp_token)}`);
}


document.addEventListener('DOMContentLoaded', function() {
    // Make sure this is called when the admintools are loaded
    if (document.getElementById('recolorCategory')) {
        initializeRecolorFunctionality();
    }
});

// Initialize recoloring functionality
function initializeRecolorFunctionality() {
    var dropdown = document.getElementById('recolor-category-dropdown');
    var currentColorDisplay = document.getElementById('current-color-display');

    // Event listener to the recolor button
    document.getElementById('recolorCategory').addEventListener('click', function() {
        var selectedCategory = dropdown.value;
        var newColor = document.getElementById('new-color').value.replace('#', ''); // Make sure to replace '#' in color value

        fetch('/recolor-category', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ categoryName: selectedCategory, newColor: newColor })
        })
        .then(response => {
            if (!response.ok) {
                throw new Error('Network response was not ok');
            }
            return response.json();
        })
        .then(result => {
            console.log('Category recolored:', result);
            refreshCategoriesDisplay(); // Make sure this function is defined and updates the display
            updateCurrentColorDisplay(selectedCategory); // Update the current color display
        })
        .catch(error => {
            console.error('Error recoloring category:', error);
        });
		    updateAllCategoryDropdowns();

    });
}

// Function to initialize the delete category dropdown
function initializeDeleteCategoryDropdown() {
  // Fetch the categories from the Flask endpoint
  fetch('/get-categories-renaming')
  .then(response => response.json())
  .then(categories => {
    var dropdown = document.getElementById('delete-category-dropdown');
    dropdown.innerHTML = ''; // Clear existing options
    
    categories.forEach(function(category) {
      var option = document.createElement('option');
      option.value = option.text = category;
      dropdown.appendChild(option);
    });
  })
  .catch(error => {
    console.error('Error fetching categories:', error);
  });
}

// Function to initialize the delete button
function initializeDeleteCategoryButton() {
  var deleteButton = document.getElementById('deleteCategory');
  deleteButton.addEventListener('click', function() {
    var selectedCategory = document.getElementById('delete-category-dropdown').value;

    fetch('/delete-category', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({ categoryName: selectedCategory })
    })
    .then(response => {
      if (!response.ok) {
        throw new Error('Network response was not ok');
      }
      return response.json();
    })
    .then(result => {
      console.log('Category deleted:', result);
      initializeDeleteCategoryDropdown(); // Re-initialize the dropdown
      refreshCategoriesDisplay(); // Refresh the categories displayed on the page
    })
    .catch(error => {
      console.error('Error deleting category:', error);
    });
	    updateAllCategoryDropdowns();
  });
}

function updateAllCategoryDropdowns() {
  // Fetch the categories from the Flask endpoint
  fetch('/get-categories-renaming')
  .then(response => {
    if (!response.ok) {
      throw new Error('Network response was not ok');
    }
    return response.json();
  })
  .then(categories => {
    const dropdowns = [
      document.getElementById('rename-category-dropdown'),
      document.getElementById('recolor-category-dropdown'),
      document.getElementById('delete-category-dropdown')
    ];

    dropdowns.forEach(dropdown => {
      dropdown.innerHTML = ''; // Clear existing options

      categories.forEach(category => {
        const option = document.createElement('option');
        option.value = option.textContent = category;
        dropdown.appendChild(option);
      });
    });
  })
  .catch(error => {
    console.error('Error fetching categories:', error);
  });
}


function loadAdminTools() {
  console.log("Attempting to load admin tools..."); // For debugging

  // Make an AJAX request to the server for the admintools content
  var xhr = new XMLHttpRequest();
  xhr.open('GET', '/admintools', true);
  xhr.onload = function() {
    if (this.status === 200) {
      // If the content is received successfully, insert it into the page
      var dynamicArea = document.getElementById('dynamicgeneration-admintools');
      dynamicArea.innerHTML = this.responseText;

      // Call the initialization functions for dynamic content here
      initializeCategoryDropdown(); // Initialize the dropdown after content is loaded
      initializeRenameCategoryButton(); // Initialize the rename button after content is loaded
      initializeRecolorDropdown(); // Initialize the recolor dropdown
      initializeRecolorFunctionality(); // Initialize the recolor button
      initializeAddCategory(); // Initialize the add category button
      initializeDeleteCategoryDropdown(); // Initialize the delete category dropdown
      initializeDeleteCategoryButton(); // Initialize the delete category button
      refreshCategoriesDisplay(); // Refresh categories after admin tools are loaded - This line was updated

    } else {
      // Handle errors, maybe redirect to login or show a message
      console.error('Failed to load admin tools:', this.statusText);
    }
  };
  xhr.onerror = function() {
    // When an error occurs during the request
    console.error("Request failed.");
  };
  xhr.send();
}


	
</script>

<?php ADMINTOOLS CATEGORIES TOGGLING START ?>
<script>
    function toggleCategory2Menu() {
        var category2Menu = document.getElementById('category2-menu');
        if (category2Menu.style.display === 'none') {
            category2Menu.style.display = 'block';
        } else {
            category2Menu.style.display = 'none';
        }
    }
</script>

<script>
function toggleHeatmapMenu() {
  var heatmapSettings = document.getElementById("heatmapSettings");
  if (heatmapSettings.style.display === "none" || heatmapSettings.style.display === "") {
    heatmapSettings.style.display = "block";
  } else {
    heatmapSettings.style.display = "none";
  }
}
</script>

<script>
    function toggleEditorMenu() {
        var editorMenu = document.getElementById('editor-menu');
        if (editorMenu.style.display === 'none') {
            editorMenu.style.display = 'block';
        } else {
            editorMenu.style.display = 'none';
        }
    }
</script>

<script>
    function togglePinsExportMenu() {
        var menu = document.getElementById('pinsexport-menu');
        var button = document.getElementById('pinsexport-menu-button');
        if (menu.style.display === 'none' || menu.style.display === '') {
            menu.style.display = 'block';
        } else {
            menu.style.display = 'none';
            button.classList.remove('toggled');
        }
    }
</script>
<?php ADMINTOOLS CATEGORIES TOGGLING END ?>
<script>
    // Assuming jQuery is included
	
    var shapeLayersByColor = {};
    var shapeLayersByType = {};
    var colorVisibilityState = {};
    var typeVisibilityState = {};

    // Initialize visibility state dictionaries
    function initializeVisibilityStates() {
        var colors = {{ color_counts | tojson }};
        var types = {{ category_counts | tojson }};
        Object.keys(colors).forEach(function(color) {
            colorVisibilityState[color] = true; // All colors visible by default
            console.log('Initialized visibility state for color', color);
        });
        Object.keys(types).forEach(function(type) {
            typeVisibilityState[type] = true; // All types visible by default
            console.log('Initialized visibility state for type', type);
        });
    }

// Function to update visibility based on both color and type
function updateVisibility(layer, color, type) {
    var visibleByColor = color ? colorVisibilityState[color] : true; // Default to true if color is undefined
    var visibleByType = typeVisibilityState[type]; // The visibility state of the type
    console.log('Updating visibility for layer. Color:', color, 'Type:', type, 'Visible by Color:', visibleByColor, 'Visible by Type:', visibleByType);

    // Change visibility only if both color and type visibility are true
    if (visibleByColor && visibleByType) {
        if (!map.hasLayer(layer)) {
            map.addLayer(layer);
            console.log('Layer shown on map:', layer);
        }
    } else {
        if (map.hasLayer(layer)) {
            map.removeLayer(layer);
            console.log('Layer removed from map:', layer);
        }
    }
}

// Modify the toggleVisibility function to handle shapes without a defined type
function toggleVisibility(color) {
    console.log('Toggling visibility for color:', color);
    colorVisibilityState[color] = !colorVisibilityState[color];
    if (shapeLayersByColor[color]) {
        shapeLayersByColor[color].forEach(function(layer) {
            var type = layer.options.shapeType || undefined; // Use undefined if shapeType isn't set
            updateVisibility(layer, color, type);
        });
    } else {
        console.log('No layers found for color:', color);
    }
}

// Toggle visibility for type
function toggleVisibilityByType(type) {
    console.log('Toggling visibility for type:', type);
    typeVisibilityState[type] = !typeVisibilityState[type];
    if (shapeLayersByType[type]) {
        shapeLayersByType[type].forEach(function(layer) {
            var color = layer.options.color || layer.options.shapeColor; // Assume each layer has a color or shapeColor property
            updateVisibility(layer, color, type);
        });
    } else {
        console.log('No layers found for type:', type);
    }
}

    $(document).ready(function() {
        // Initialize visibility states when document is ready
        initializeVisibilityStates();

    var colorCounts = {{ color_counts | tojson }};
            Object.entries(colorCounts).forEach(([color, count]) => {
        var colorCircle = $(`<span class="counter-color" style="background-color: ${color};"></span>`);
        var listItem = $(`<li style="margin-right: 5px;">`).append(colorCircle).append(` ${count}`);
        listItem.on('click', function() {
            toggleVisibility(color);
            // Dim the circle by adjusting the opacity
            if (colorCircle.css('opacity') == '1') {
                colorCircle.css('opacity', '0.5'); // Dim it
            } else {
                colorCircle.css('opacity', '1'); // Return to full opacity
            }
        });
        $('#color-counters').append(listItem);
    });

        // Populate category counters
        var categoryCounts = {{ category_counts | tojson }};
        Object.entries(categoryCounts).forEach(([category, count]) => {
            var symbol = '';
            switch(category) {
                case 'circle': symbol = '<img src="static/circle_darkmode.png" alt="Circle" class="category-symbol" />'; break;
                case 'polygon': symbol = '<img src="static/polygon_darkmode.png" alt="Polygon" class="category-symbol" />'; break;
                case 'rectangle': symbol = '<img src="static/rectangle_darkmode.png" alt="Rectangle" class="category-symbol" />'; break;
                case 'marker': symbol = '<img src="static/pin_darkmode.png" alt="Marker" class="category-symbol" />'; break;
                // Add more cases for other categories if necessary
            }
            $('#category-counters').append(
    $(`<li style="margin-right: 5px;">`).append(
        $(symbol).on('click', function() {
            toggleVisibilityByType(category);
            // Dim the symbol by adjusting the opacity
            $(this).css('opacity', $(this).css('opacity') == '1' ? '0.5' : '1');
        })
    ).append(` ${count}`)
);
        });

        console.log("Counters displayed.");
    });
</script>
</body>
</html>
