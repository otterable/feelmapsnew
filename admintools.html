<style>
    input, select, button {
        border-radius: 30px;
        padding: 5px;
        border: 1.5px solid black;
    }
	
	         .admintools-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }

        .toggle-button {
            background-color: #35b7ff;
            font-weight: bold;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 14px 0;
            padding: 15px;
            box-sizing: border-box;
            cursor: pointer;
            text-decoration: none;
            white-space: normal;
            border-radius: 30px;
            transition: background-color 0.2s ease-in-out;
            color: white;
            text-align: center;
            line-height: 1;
            max-height: 40px;
            width: 100%;
        }
		
	   .centered-title {
        text-align: center;
        width: 100%;
    }
	
	
</style>

<!-- jQuery -->
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

<!-- Leaflet CSS -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.8.0/dist/leaflet.css" />

<!-- Leaflet Draw Plugin CSS -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/1.0.4/leaflet.draw.css" />

<!-- Leaflet JavaScript Library -->
<script src="https://unpkg.com/leaflet@1.8.0/dist/leaflet.js"></script>

<!-- Leaflet Draw Plugin JavaScript -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/1.0.4/leaflet.draw.js"></script>
<!-- Include Spectrum's CSS from CDN -->
<link rel="stylesheet" type="text/css" href="https://cdnjs.cloudflare.com/ajax/libs/spectrum/1.8.1/spectrum.min.css" />
<meta charset="UTF-8">

<!-- Include Spectrum's JavaScript from CDN -->
<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/spectrum/1.8.1/spectrum.min.js"></script>
<!-- Your additional scripts and libraries -->
<script src="https://cdn.quilljs.com/1.3.6/quill.js"></script>
<link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet"/>
<!-- Popup Container -->


<!-- HEATMAPZ EDITOR ADMIN START -->




<div class="admintools-container color-111111 text-white" style="display:flex;             color: #ffffff;  /* This makes the text color white */ ; margin-top: 15px;  margin-bottom: 15px; border-radius: 30px">

<button class="toggle-button" id="toggle-category-menu">Category options</button>

<div id="category-menu" style="display: none;">
    <select id="category-select">
        <!-- Category options will be dynamically generated -->
    </select>
    <input type="color" id="color-picker">
    <button type="button" id="update-color">Update Color</button>
	
        <select id="rename-category-select"></select>
        <input type="text" id="rename-category-name" placeholder="Enter new category name" />
        <button id="rename-category">Rename Category</button>
		
		      <input type="text" id="create-category-name" placeholder="Enter new category name" />
        <input type="color" id="create-category-color" />
        <button id="create-category">Create Category</button>
</div>

    <script>
        document.getElementById('toggle-category-menu').addEventListener('click', function() {
            var categoryMenu = document.getElementById('category-menu');
            categoryMenu.style.display = categoryMenu.style.display === 'none' ? 'block' : 'none';
        });
    </script>

<script>
$(document).ready(function() {
    // Fetch categories and populate dropdown
    fetch('/get-categories').then(response => response.json()).then(data => {
        data.forEach(category => {
            // Append the category to the select dropdown
            $('#category-select').append(new Option(category.text, category.color));
        });

        // Set the initial value of the HEX editor to the first category's color
        $('#color-picker').val($('#category-select').val());
    });

    // Update the HEX editor when the selected category changes
    $('#category-select').change(function() {
        // Set the HEX editor to the currently selected category's color
        $('#color-picker').val($(this).val());
    });

    // Handle the color update
    $('#update-color').click(function() {
    var oldColor = $('#category-select').val();
    var newColor = $('#color-picker').val();
    console.log(`Updating color from ${oldColor} to ${newColor}`);

    // Update the category color
    $.ajax({
        url: '/update-category',
        method: 'POST',
        contentType: 'application/json',
        data: JSON.stringify({ oldColor: oldColor, newColor: newColor }),
        success: function(response) {
            console.log('Category color updated successfully:', response);
            
            // Now update the shapes in the database with the new color
            $.ajax({
                url: '/update-shape-colors',
                method: 'POST',
                contentType: 'application/json',
                data: JSON.stringify({ oldColor: oldColor, newColor: newColor }),
                success: function(response) {
                    console.log('Shapes color updated successfully:', response);
                    // Optionally refresh the map or shapes to reflect the color change
                },
                error: function(xhr, status, error) {
                    console.error('Error updating shapes color:', error);
                }
            });
        },
        error: function(xhr, status, error) {
            console.error('Error updating category color:', error);
        }
    });
});

});

</script>

 
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Event delegation for dynamically loaded content
    document.body.addEventListener('click', function(event) {
        if (event.target.id === 'toggle-category-menu2') {
            var categoryMenu = document.getElementById('category-menu');
            categoryMenu.style.display = categoryMenu.style.display === 'none' ? 'block' : 'none';
        } else if (event.target.id === 'toggle-rename-category') {
            var renameCategoryContent = document.getElementById('rename-category-content');
            renameCategoryContent.style.display = renameCategoryContent.style.display === 'none' ? 'block' : 'none';
        } else if (event.target.id === 'toggle-create-category') {
            var createCategoryContent = document.getElementById('create-category-content');
            createCategoryContent.style.display = createCategoryContent.style.display === 'none' ? 'block' : 'none';
        } else if (event.target.id === 'toggle-delete-category') {
            var deleteCategoryContent = document.getElementById('delete-category-content');
            deleteCategoryContent.style.display = deleteCategoryContent.style.display === 'none' ? 'block' : 'none';
        } else if (event.target.id === 'toggle-geojson-options') {
            var geojsonOptionsContent = document.getElementById('geojson-options-content');
            geojsonOptionsContent.style.display = geojsonOptionsContent.style.display === 'none' ? 'block' : 'none';
        }
		  else if (event.target.id === 'toggle-object-type-restriction') {
            var objectTypeRestrictionContent = document.getElementById('object-type-restriction-content');
            objectTypeRestrictionContent.style.display = objectTypeRestrictionContent.style.display === 'none' ? 'block' : 'none';
        }
    });
});
</script>
	
<script>
$(document).ready(function() {
    // Fetch categories and populate the rename dropdown
    fetch('/get-categories').then(response => response.json()).then(data => {
        data.forEach(category => {
            $('#rename-category-select').append(new Option(category.text, category.color));
            // Populate the hex editor with the current color
            $('#color-picker').val(category.color);
        });
    });

    // Handle the category rename
    $('#rename-category').click(function() {
        var color = $('#rename-category-select').val();
        var newName = $('#rename-category-name').val().trim();
        if (newName === "") {
            console.error('New category name is required');
            return;
        }
        console.log(`Renaming category ${color} to ${newName}`);
        
        $.ajax({
            url: '/rename-category',
            method: 'POST',
            contentType: 'application/json',
            data: JSON.stringify({ color: color, newName: newName }),
            success: function(response) {
                console.log('Category renamed successfully:', response);
                // Optionally refresh the categories in the dropdown and other related UI
            },
            error: function(xhr, status, error) {
                console.error('Error renaming category:', error);
            }
        });
    });
});

</script>




<script>
$(document).ready(function() {
    // Handle the category creation
    $('#create-category').click(function() {
        setTimeout(() => { // Adding a delay to ensure the input value is updated
            var name = $('#create-category-name').val().trim();
            var color = $('#create-category-color').val();
            console.log(`Inputted name: '${name}'`); // Log the inputted name for debugging
            console.log(`Selected color: '${color}'`); // Log the selected color for debugging
            
            if (name === "") {
                console.error('Category name is required');
                return;
            }
            console.log(`Creating new category '${name}' with color '${color}'`);
            
            $.ajax({
                url: '/create-category',
                method: 'POST',
                contentType: 'application/json',
                data: JSON.stringify({ name: name, color: color }),
                success: function(response) {
                    console.log('Category created successfully:', response);
                    // Optionally refresh the categories in the UI
                },
                error: function(xhr, status, error) {
                    console.error('Error creating category:', error);
                }
            });
        }, 100); // Delay of 100 milliseconds
    });
});
</script>

<!-- Category Deletion Section -->
  <button class="toggle-button" id="toggle-delete-category">Deletion options</button>
    <div id="delete-category-content" style="display: none;">
        <select id="delete-category-select">
            <!-- Options will be dynamically populated -->
        </select>
        <button id="delete-category">Delete Category</button>
		
		<h2>Delete Objects by Category</h2>

<button id="delete-category-objects">Delete Only objects of the category</button>

<!-- Delete Objects by Object Type -->
<h2>Delete Objects by Object Type</h2>
<select id="delete-object-type-select">
    <option value="circle">Circle</option>
    <option value="rectangle">Rectangle</option>
    <option value="polygon">Polygon</option>
    <option value="polyline">Polyline</option>
    <option value="circlemarker">Circle Marker</option>
    <option value="marker">Marker</option>
    <!-- Add more object types as needed -->
</select>
<button id="delete-object-type-objects">Delete Objects</button>



    </div>

<script>
$(document).ready(function() {
    // Populate the delete category dropdown
    fetchCategories();

    // Handle the category deletion
    $('#delete-category').click(function() {
        var color = $('#delete-category-select').val();
        console.log(`Deleting category with color ${color}`);

        $.ajax({
            url: '/delete-category',
            method: 'POST',
            contentType: 'application/json',
            data: JSON.stringify({ color: color }),
            success: function(response) {
                console.log('Category deleted successfully:', response);
                // Refresh the categories in the dropdowns
                fetchCategories();
            },
            error: function(xhr, status, error) {
                console.error('Error deleting category:', error);
            }
        });
    });
});

function fetchCategories() {
    fetch('/get-categories').then(response => response.json()).then(data => {
        var categorySelect = $('#delete-category-select');
        categorySelect.empty(); // Clear existing options
        data.forEach(category => {
            categorySelect.append(new Option(category.text, category.color));
        });
    });
}
</script>

<script>
    function toggleCategory2Menu() {
        var category2Menu = document.getElementById('category2-menu');
        if (category2Menu.style.display === 'none') {
            category2Menu.style.display = 'block';
        } else {
            category2Menu.style.display = 'none';
        }
    }
</script>

  <button class="toggle-button" id="toggle-geojson-options">GeoJSON Options</button>
    <div id="geojson-options-content" style="display: none;">
        <button onclick="window.location.href='/export-geojson'">Export GeoJSON</button>
        
        <!-- Add a form for importing GeoJSON -->
        <form action="/import-geojson" method="POST" enctype="multipart/form-data">
            <input type="file" name="file" accept=".geojson">
            <button type="submit">Import GeoJSON</button>
        </form>
    </div>


<!-- ADMINTOOLS CATEGORY LOADING END-->

<!-- Delete Objects by Category -->


<script>
$(document).ready(function() {
    // Populate the delete category dropdown
    fetchCategories();

    // Handle the category deletion
    $('#delete-category-objects').click(function() {
        var color = $('#delete-category-select').val();
        console.log(`Deleting objects with category color ${color}`);

        $.ajax({
            url: '/delete-objects-by-category',
            method: 'POST',
            contentType: 'application/json',
            data: JSON.stringify({ color: color }),
            success: function(response) {
                console.log('Objects deleted successfully:', response);
                // Refresh the categories in the dropdowns
                fetchCategories();
            },
            error: function(xhr, status, error) {
                console.error('Error deleting objects by category:', error);
            }
        });
    });

    // Handle the object type deletion
    $('#delete-object-type-objects').click(function() {
        var objectType = $('#delete-object-type-select').val();
        console.log(`Deleting objects of type ${objectType}`);

        $.ajax({
            url: '/delete-objects-by-object-type',
            method: 'POST',
            contentType: 'application/json',
            data: JSON.stringify({ objectType: objectType }),
            success: function(response) {
                console.log('Objects deleted successfully:', response);
                // Optionally refresh the map or shapes to reflect the deletion
            },
            error: function(xhr, status, error) {
                console.error('Error deleting objects by object type:', error);
            }
        });
    });

    // Other JavaScript code here...
});
</script>

<button class="toggle-button" id="toggle-object-type-restriction">Object permissions / Map boundary creation / Pin resizing</button>
    <div id="object-type-restriction-content" style="display: none;">
        <form id="object-type-restriction-form">
            <input type="checkbox" id="allow-marker" name="marker" checked> <label for="allow-marker">Marker</label><br>
            <input type="checkbox" id="allow-rectangle" name="rectangle" checked> <label for="allow-rectangle">Rectangle</label><br>
            <input type="checkbox" id="allow-circle" name="circle" checked> <label for="allow-circle">Circle</label><br>
            <input type="checkbox" id="allow-polygon" name="polygon" checked> <label for="allow-polygon">Polygon</label><br>
            <button type="submit">Submit</button>
        </form>
    </div>


<script>
// Function to update category dropdowns
function updateCategoryDropdowns() {
    console.log("Fetching updated categories from the server."); // Debugging statement

    fetch('/get-categories')
        .then(response => response.json())
        .then(categories => {
            console.log("Received categories:", categories); // Debugging statement

            // Dropdown elements
            const dropdowns = [
                document.getElementById('category-select'),
                document.getElementById('rename-category-select'),
                document.getElementById('delete-category-select')
            ];

            // Clear existing options in dropdowns
            dropdowns.forEach(dropdown => {
                while (dropdown.firstChild) {
                    dropdown.removeChild(dropdown.firstChild);
                }
            });

            // Add new options to dropdowns
            categories.forEach(category => {
                dropdowns.forEach(dropdown => {
                    const option = document.createElement('option');
                    option.value = category.text;
                    option.textContent = category.text;
                    option.style.color = category.color;
                    dropdown.appendChild(option);
                });
            });

            console.log("Dropdowns updated successfully."); // Debugging statement
        })
        .catch(error => {
            console.error("Error fetching categories:", error); // Debugging statement
        });
}
 updateCategoryDropdowns
</script>

    <form id="sizeForm">
        <label for="pinSize">Pin Size:</label>
        <select id="pinSize" name="pin_size">
            <option value="18">XXS</option>
            <option value="20">XS</option>
            <option value="24">S</option>
            <option value="32" selected>M (Default)</option>
            <option value="48">L</option>
            <option value="60">XL</option>
        </select>
        <label for="outlineSize">Outline Size:</label>
        <select id="outlineSize" name="outline_size">
            <option value="6">XXS</option>
            <option value="10">XS</option>
            <option value="12">S</option>
            <option value="16" selected>M (Default)</option>
            <option value="20">L</option>
            <option value="24">XL</option>
            <option value="32">XXL</option>
            <option value="48">XXXL</option>
        </select>
        <button type="submit">Update Sizes</button>
    </form>

    <script>
        document.getElementById('sizeForm').addEventListener('submit', function(e) {
            e.preventDefault();
            const pinSize = document.getElementById('pinSize').value;
            const outlineSize = document.getElementById('outlineSize').value;

            fetch('/update_sizes', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ pin_size: parseInt(pinSize), outline_size: parseInt(outlineSize) }),
            })
            .then(response => response.json())
            .then(data => console.log(data.message))
            .catch((error) => {
                console.error('Error:', error);
            });
        });
    </script>
	
	
    <div id="admin-map"></div>

    <style>
        #admin-map {
            height: 400px;
            width: 600px;
        }
    </style>
<script>
        var map = L.map('admin-map').setView([48.4102, 15.6022], 15);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            maxZoom: 19,
            attribution: 'Stimmungskompass boundary editing tool | © OpenStreetMap contributors'
        }).addTo(map);

        var drawnItems = new L.FeatureGroup();
        map.addLayer(drawnItems);

        var drawControl = new L.Control.Draw({
            edit: {
                featureGroup: drawnItems
            },
            draw: {
                polyline: true,
                polygon: true,
                circle: true,
                marker: false,
                rectangle: false,
                circlemarker: false
            }
        });
        map.addControl(drawControl);

        map.on(L.Draw.Event.CREATED, function (e) {
            var type = e.layerType,
                layer = e.layer;

            drawnItems.addLayer(layer);

            var shapeData = layer.toGeoJSON();
            var shapeType = type;
            var radius = type === 'circle' ? layer.getRadius() : null;

            layer.bindPopup(getPopupContent(), {keepInView: true});
            layer.on('popupopen', function() {
                document.getElementById('save-shape').addEventListener('click', function() {
                    var note = document.getElementById('shape-note').value;
                    var imageFile = document.getElementById('shape-image').files[0];
                    saveShapeWithData(shapeData, shapeType, radius, note, layer, imageFile);
                });
            });
        });

        function getPopupContent() {
            return `
                <form id="shape-form">
                    <textarea id="shape-note" placeholder="Add a note..."></textarea>
                    <input type="file" id="shape-image" accept="image/*">
                    <button type="button" id="save-shape">Save</button>
                </form>
            `;
        }

        function saveShapeWithData(shapeData, shapeType, radius, note, layer, imageFile) {
            var formData = new FormData();
            formData.append('shape_data', JSON.stringify(shapeData));
            formData.append('shape_type', shapeType);
            formData.append('radius', radius);
            formData.append('note', note);
            if (imageFile) {
                formData.append('image', imageFile);
            }

            fetch('/api/shapes', {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                console.log('Shape saved with ID:', data.id);
                layer.options.id = data.id;
                bindPopupWithNoteAndImage(layer, note, data.imageUrl);
            })
            .catch(error => console.error('Error saving shape:', error));
        }

        function bindPopupWithNoteAndImage(layer, note, imageUrl) {
            var popupContent = `<div><strong>Note:</strong> ${note}</div>`;
            if (imageUrl) {
                popupContent += `<img src="${imageUrl}" alt="Uploaded Image" style="width:100%;height:auto;">`;
            }
            layer.bindPopup(popupContent, {keepInView: true});
        }

        // Load existing shapes
        function loadExistingShapes() {
            fetch('/api/shapes')
            .then(response => response.json())
            .then(data => {
                data.shapes.forEach(shape => {
                    var layer;
                    var shapeType = shape.shape_type;
                    var shapeData = shape.shape_data;
                    // ... (existing code to add shapes to the map)
                });
            })
            .catch(error => console.error('Error loading shapes:', error));
        }
        loadExistingShapes();

    </script>
	
	
<!-- Object Type Restriction Section -->
     

<script>
document.getElementById('object-type-restriction-form').addEventListener('submit', function(event) {
    event.preventDefault();

    var formData = {
        marker: document.getElementById('allow-marker').checked,
        rectangle: document.getElementById('allow-rectangle').checked,
        circle: document.getElementById('allow-circle').checked,
        polygon: document.getElementById('allow-polygon').checked
    };

    console.log('Submitting allowed object types:', formData);

    fetch('/update-allowed-object-types', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify(formData)
    })
    .then(response => response.json())
    .then(result => {
        console.log('Allowed object types updated:', result);
        // Optionally, give feedback to the user
    })
    .catch(error => {
        console.error('Error updating allowed object types:', error);
    });
});
</script>
